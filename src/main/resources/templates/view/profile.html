<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{view/layout}">

<head>
    <title layout:title-pattern="$CONTENT_TITLE - $LAYOUT_TITLE">Profile</title>
</head>

<body>
    <div layout:fragment="content">
        <!-- Profile Header Section -->
        <section class="bg-primary text-white py-5">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-md-3 text-center">
                        <!-- Profile Picture -->
                        <img th:src="${user?.profileImage ?: 'https://via.placeholder.com/150x150'}" 
                             class="rounded-circle img-fluid mb-3" alt="Profile Picture">
                    </div>
                    <div class="col-md-9">
                        <!-- User Information -->
                        <h1 class="display-5 fw-bold mb-2" th:text="${user?.fullName ?: 'John Collector'}">John Collector</h1>
                        <p class="lead mb-1">
                            <i class="fas fa-envelope me-2"></i>
                            <span th:text="${user?.email ?: 'john.collector@email.com'}">john.collector@email.com</span>
                        </p>
                        <p class="mb-3">
                            <i class="fas fa-calendar me-2"></i>
                            <span>Member since <span th:text="${user?.createdAt ? #temporals.format(user.createdAt, 'MMMM yyyy') : 'March 2023'}">March 2023</span></span>
                        </p>
                        <!-- Edit Profile Button -->
                        <button class="btn btn-light" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                            <i class="fas fa-edit me-1"></i>Edit Profile
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Profile Content Section -->
        <section class="py-5">
            <div class="container">
                <div class="row">
                    <!-- Left Sidebar - Profile Stats and Quick Actions -->
                    <div class="col-lg-3 mb-4">
                        <!-- Profile Statistics Card -->
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Profile Stats</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Total Spins:</span>
                                    <strong th:text="${userStats?.totalSpins ?: '247'}">247</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Prizes Won:</span>
                                    <strong th:text="${userStats?.prizesWon ?: '156'}">156</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Orders Made:</span>
                                    <strong th:text="${userStats?.ordersMade ?: '23'}">23</strong>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Total Value:</span>
                                    <strong class="text-success" th:text="'$' + ${userStats?.totalValue ?: '1,234'}">$1,234</strong>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions Card -->
                        <div class="card mt-4">
                            <div class="card-header">
                                <h5 class="mb-0">Quick Actions</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <a href="/spin-history" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-history me-1"></i>View All Spins
                                    </a>
                                    <a href="/#products" class="btn btn-outline-success btn-sm">
                                        <i class="fas fa-shopping-cart me-1"></i>Shop Products
                                    </a>
                                    <button class="btn btn-outline-info btn-sm" onclick="downloadProfile()">
                                        <i class="fas fa-download me-1"></i>Export Data
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Main Content - Spin History Section -->
                    <div class="col-lg-9">
                        <div class="card">
                            <!-- Card Header with Actions -->
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-history me-2"></i>Recent Spin History
                                </h5>
                                <!-- Show bulk actions only if there are items -->
                                <div th:if="${spinHistory != null and !spinHistory.isEmpty()}">
                                    <button class="btn btn-success btn-sm me-2" onclick="orderSelected()" id="orderBtn" disabled>
                                        <i class="fas fa-shopping-cart me-1"></i>Order Selected (<span id="selectedCount">0</span>)
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="toggleSelectAll()">
                                        <i class="fas fa-check-double me-1"></i>Select All
                                    </button>
                                </div>
                            </div>
                            
                            <div class="card-body">
                                <!-- Spin History Table - Show only if data exists -->
                                <div th:if="${spinHistory != null and !spinHistory.isEmpty()}" class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th width="50">
                                                    <input type="checkbox" class="form-check-input" id="selectAllCheckbox" onchange="selectAll()">
                                                </th>
                                                <th>Prize</th>
                                                <th>Rarity</th>
                                                <th>Date</th>
                                                <th>Value</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="spinHistoryTable">
                                            <!-- Loop through spin history items -->
                                            <tr th:each="prize : ${spinHistory}">
                                                <td>
                                                    <!-- Checkbox for selecting items to order -->
                                                    <input type="checkbox" class="form-check-input prize-checkbox" 
                                                           th:data-prize-id="${prize.id}" 
                                                           th:data-value="${prize.value}" 
                                                           onchange="updateSelection()" 
                                                           th:disabled="${prize.status == 'ORDERED'}">
                                                </td>
                                                <td>
                                                    <!-- Prize information with image and details -->
                                                    <div class="d-flex align-items-center">
                                                        <img th:src="${prize.imageUrl ?: 'https://via.placeholder.com/40x40'}" 
                                                             class="me-2 rounded" alt="Prize">
                                                        <div>
                                                            <div class="fw-bold" th:text="${prize.name}">Prize Name</div>
                                                            <small class="text-muted" th:text="${prize.series}">Series</small>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <!-- Rarity badge with appropriate color -->
                                                    <span class="badge" 
                                                          th:classappend="${prize.rarity == 'LEGENDARY'} ? 'bg-warning text-dark' : 
                                                                         ${prize.rarity == 'EPIC'} ? 'bg-danger' : 
                                                                         ${prize.rarity == 'RARE'} ? 'bg-info' : 'bg-secondary'"
                                                          th:text="${prize.rarity}">Common</span>
                                                </td>
                                                <td>
                                                    <!-- Date and time of spin -->
                                                    <div th:text="${#temporals.format(prize.wonAt, 'MMMM dd, yyyy')}">March 15, 2024</div>
                                                    <small class="text-muted" th:text="${#temporals.format(prize.wonAt, 'HH:mm')}">14:30</small>
                                                </td>
                                                <td class="fw-bold text-success" th:text="'$' + ${prize.value}">$150.00</td>
                                                <td>
                                                    <!-- Status badge -->
                                                    <span class="badge" 
                                                          th:classappend="${prize.status == 'AVAILABLE'} ? 'bg-success' : 'bg-warning'"
                                                          th:text="${prize.status}">Available</span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    
                                    <!-- View All Spins Link -->
                                    <div class="text-center mt-3">
                                        <a href="/spin-history" class="btn btn-outline-primary">
                                            <i class="fas fa-history me-1"></i>View All Spin History
                                        </a>
                                    </div>
                                </div>

                                <!-- Empty State - Show when no spin history exists -->
                                <div th:if="${spinHistory == null or spinHistory.isEmpty()}" class="text-center py-5">
                                    <div class="card border-0">
                                        <div class="card-body">
                                            <i class="fas fa-dice fa-4x text-muted mb-4"></i>
                                            <h4 class="text-muted mb-3">No Spin History</h4>
                                            <p class="text-muted mb-4">You haven't made any spins yet. Start spinning to win amazing prizes!</p>
                                            <a href="/#products" class="btn btn-primary">Start Spinning</a>
                                        </div>
                                    </div>
                                </div>

                                <!-- Order Summary - Hidden by default, shown when items are selected -->
                                <div id="orderSummary" class="alert alert-info mt-3" style="display: none;">
                                    <h6><i class="fas fa-info-circle me-1"></i>Order Summary</h6>
                                    <p class="mb-1">Selected items: <span id="summaryCount">0</span></p>
                                    <p class="mb-0">Total value: $<span id="summaryTotal">0.00</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Edit Profile Modal -->
        <div class="modal fade" id="editProfileModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Profile</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Profile Edit Form -->
                        <form th:action="@{/profile/update}" method="post">
                            <div class="mb-3">
                                <label for="profileName" class="form-label">Full Name</label>
                                <input type="text" class="form-control" id="profileName" name="fullName" th:value="${user?.fullName}">
                            </div>
                            <div class="mb-3">
                                <label for="profileEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="profileEmail" name="email" th:value="${user?.email}">
                            </div>
                            <div class="mb-3">
                                <label for="profilePhone" class="form-label">Phone</label>
                                <input type="tel" class="form-control" id="profilePhone" name="phone" th:value="${user?.phone}">
                            </div>
                            <div class="mb-3">
                                <label for="profileAddress" class="form-label">Address</label>
                                <textarea class="form-control" id="profileAddress" name="address" rows="3" th:text="${user?.address}"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="saveProfile()">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Confirmation Modal -->
        <div class="modal fade" id="orderModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Confirm Order</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="orderModalBody">
                        <!-- Order details will be populated here by JavaScript -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="confirmOrder()">Confirm Order</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript for Profile Page -->
    <th:block layout:fragment="scripts">
        <script>
            // Array to store selected prizes for ordering
            let selectedPrizes = [];

            /**
             * Update the selection UI when checkboxes are changed
             */
            function updateSelection() {
                const checkboxes = document.querySelectorAll('.prize-checkbox:checked');
                const count = checkboxes.length;
                let total = 0;

                // Reset selected prizes array
                selectedPrizes = [];
                
                // Calculate total and build selected prizes array
                checkboxes.forEach(checkbox => {
                    const value = parseFloat(checkbox.dataset.value);
                    total += value;
                    selectedPrizes.push({
                        id: checkbox.dataset.prizeId,
                        value: value,
                        element: checkbox.closest('tr')
                    });
                });

                // Update UI elements
                document.getElementById('selectedCount').textContent = count;
                document.getElementById('orderBtn').disabled = count === 0;

                // Show/hide order summary
                const orderSummary = document.getElementById('orderSummary');
                if (count > 0) {
                    document.getElementById('summaryCount').textContent = count;
                    document.getElementById('summaryTotal').textContent = total.toFixed(2);
                    orderSummary.style.display = 'block';
                } else {
                    orderSummary.style.display = 'none';
                }
            }

            /**
             * Select/deselect all available checkboxes
             */
            function selectAll() {
                const selectAllCheckbox = document.getElementById('selectAllCheckbox');
                const checkboxes = document.querySelectorAll('.prize-checkbox:not([disabled])');
                
                checkboxes.forEach(checkbox => {
                    checkbox.checked = selectAllCheckbox.checked;
                });
                
                updateSelection();
            }

            /**
             * Toggle select all checkbox state
             */
            function toggleSelectAll() {
                const selectAllCheckbox = document.getElementById('selectAllCheckbox');
                selectAllCheckbox.checked = !selectAllCheckbox.checked;
                selectAll();
            }

            /**
             * Show order confirmation modal with selected items
             */
            function orderSelected() {
                if (selectedPrizes.length === 0) return;

                let orderDetails = '<h6>Selected Items:</h6><ul class="list-group">';
                let total = 0;

                selectedPrizes.forEach(prize => {
                    const row = prize.element;
                    const prizeInfo = row.cells[1].textContent.trim();
                    const value = prize.value;
                    total += value;

                    orderDetails += `<li class="list-group-item d-flex justify-content-between">
                        <span>${prizeInfo}</span>
                        <strong>$${value.toFixed(2)}</strong>
                    </li>`;
                });

                orderDetails += `</ul>
                    <div class="mt-3 p-3 bg-light rounded">
                        <h6>Order Total: <span class="text-success">$${total.toFixed(2)}</span></h6>
                    </div>`;

                document.getElementById('orderModalBody').innerHTML = orderDetails;
                
                const modal = new bootstrap.Modal(document.getElementById('orderModal'));
                modal.show();
            }

            /**
             * Confirm and process the order
             */
            function confirmOrder() {
                // Collect selected prize IDs
                const prizeIds = selectedPrizes.map(prize => prize.id);
                
                // Send order request to server
                fetch('/api/orders/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ prizeIds: prizeIds })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Mark selected items as ordered in the UI
                        selectedPrizes.forEach(prize => {
                            const row = prize.element;
                            const statusCell = row.cells[5];
                            statusCell.innerHTML = '<span class="badge bg-warning">Ordered</span>';
                            
                            // Disable the checkbox
                            const checkbox = row.querySelector('.prize-checkbox');
                            checkbox.checked = false;
                            checkbox.disabled = true;
                        });

                        // Close modal and update UI
                        bootstrap.Modal.getInstance(document.getElementById('orderModal')).hide();
                        updateSelection();

                        // Show success notification
                        showNotification(`Order placed successfully! ${selectedPrizes.length} items ordered.`, 'success');
                    } else {
                        showNotification('Failed to place order. Please try again.', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('An error occurred while placing the order.', 'error');
                });
            }

            /**
             * Save profile changes
             */
            function saveProfile() {
                // Submit the form in the modal
                document.querySelector('#editProfileModal form').submit();
            }

            /**
             * Download profile data (placeholder function)
             */
            function downloadProfile() {
                // This would typically generate and download a file with user data
                alert('Profile data export functionality would be implemented here');
            }

            // Initialize the page when DOM is loaded
            document.addEventListener('DOMContentLoaded', function() {
                updateSelection();
            });
        </script>
    </th:block>
</body>
</html>
